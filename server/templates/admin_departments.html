<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Classync ‚Äì Manage Departments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Poppins font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Reuse main admin styles -->
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/admin_dashboard.css') }}"
  />

  <!-- Page-specific styles -->
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/admin_departments.css') }}"
  />
</head>
<body>
  <div class="admin-page">

    <!-- Navbar -->
    <header class="admin-navbar">
      <div class="admin-nav-left">
        <a href="{{ url_for('admin_dashboard') }}" class="admin-logo admin-logo-link">
          Classync
        </a>
      </div>

      <div class="admin-nav-center">
        <div class="admin-nav-title">Departments</div>
      </div>

      <div class="admin-nav-right">
        <div class="admin-profile">
          <div class="admin-avatar">
            {{ (current_user.name[0:1]|upper ~ (current_user.name.split(' ')[-1][0:1]|upper if current_user.name.split(' ')|length > 1 else "")) if current_user else "AD" }}
          </div>
          <div class="admin-profile-text">
            <div class="admin-profile-name">
              {{ current_user.name if current_user else "Admin User" }}
            </div>
            <div class="admin-profile-role">Administrator</div>
          </div>
        </div>

        <a href="{{ url_for('logout') }}" class="admin-logout-btn">
          <span class="logout-icon">‚èª</span> Logout
        </a>
      </div>
    </header>

    <!-- MAIN -->
    <main class="admin-main">

      <!-- Header + Add button -->
      <section class="departments-header">
        <div>
          <h1 class="page-title">Manage Departments</h1>
          <p class="page-subtitle">
            Create and organise departments, and link them to faculties.
          </p>
        </div>
        <button id="toggleAddDepartment" class="primary-btn">
          + Add new department
        </button>
      </section>

      <!-- Slide-down Add Department form -->
      <section class="add-dept-wrapper" id="addDepartmentWrapper">
        <div class="add-dept-card">
          <div class="add-dept-header">
            <h2>Add new department</h2>
            <button id="closeAddDepartment" class="close-btn" aria-label="Close">‚úï</button>
          </div>

          <form id="addDepartmentForm"
                method="POST"
                action="{{ url_for('admin_create_department') }}">
            <input type="hidden" name="is_edit" id="is_edit_department" value="no">
            <input type="hidden" name="edit_department_id" id="edit_department_id" value="">

            <div class="form-grid">
              <!-- Dept code -->
              <div class="form-group">
                <label for="dept_code">Department code</label>
                <input type="text" name="dept_id" id="dept_code" required />
              </div>

              <!-- Department name -->
              <div class="form-group">
                <label for="dept_name">Department name</label>
                <input type="text" name="name" id="dept_name" required />
              </div>

              <!-- Faculty dropdown -->
              <div class="form-group">
                <label for="dept_faculty">Faculty</label>
                <select name="faculty_id" id="dept_faculty" required>
                  <option value="">-- Select faculty --</option>
                  {% for f in faculties %}
                    <option value="{{ f.faculty_id }}">{{ f.faculty_id }} ‚Äì {{ f.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-secondary" id="cancelAddDepartment">
                Cancel
              </button>
              <button type="submit" class="primary-btn">
                Save department
              </button>
            </div>
          </form>
        </div>
      </section>

      <!-- Departments overview + filters -->
      <section class="departments-overview">
        <div class="overview-header-row">
          <h2 class="overview-title">Departments Overview</h2>

          <div class="table-filters">
            <!-- SEARCH -->
            <div class="filter-group">
              <div class="filter-label">SEARCH</div>
              <div class="filter-control filter-search">
                <input
                  type="text"
                  id="deptSearch"
                  placeholder="Search by department or faculty"
                />
                <span class="filter-search-icon">üîç</span>
              </div>
            </div>

            <!-- FACULTY FILTER -->
            <div class="filter-group">
              <div class="filter-label">FACULTY</div>
              <div class="filter-control">
                <select id="deptFacultyFilter">
                  <option value="all">All faculties</option>
                  {% for f in faculties %}
                    <!-- Use faculty_id so it matches department.faculty_id -->
                    <option value="{{ f.faculty_id }}">{{ f.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="overview-divider"></div>
      </section>

      <!-- Departments table -->
      <section class="departments-table-section">
        <div class="card">
          <div class="card-header-row">
            <h2 class="card-title">Existing departments</h2>
            <div class="card-header-right">
              <span class="card-count">{{ departments|length if departments else 0 }} total</span>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="departments-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Dept code</th>
                  <th>Department name</th>
                  <th>Faculty ID</th>
                  <th>Faculty name</th>
                  <th>Actions</th>
                </tr>
              </thead>

              <tbody>
                {% if departments and departments|length > 0 %}
                  {% for d in departments %}
                  <tr
                    data-id="{{ d.id }}"
                    data-dept-id="{{ d.dept_id }}"
                    data-name="{{ d.name }}"
                    data-faculty-id="{{ d.faculty_id }}"
                  >
                    <td>{{ d.id }}</td>
                    <td>{{ d.dept_id }}</td>
                    <td>{{ d.name }}</td>
                    <td>{{ d.faculty_id }}</td>
                    <td>{{ d.faculty_name or '-' }}</td>
                    <td>
                      <!-- Edit button -->
                      <button type="button"
                              class="table-btn table-btn-edit dept-edit-btn"
                              data-id="{{ d.id }}"
                              data-dept-id="{{ d.dept_id }}"
                              data-name="{{ d.name }}"
                              data-faculty-id="{{ d.faculty_id }}">
                        <img src="{{ url_for('static', filename='img/pen.png') }}" class="row-icon" />
                      </button>

                      <!-- Delete button (AJAX via JS) -->
                      <button type="button"
                              class="table-btn table-btn-delete dept-delete-btn"
                              data-id="{{ d.id }}"
                              data-name="{{ d.name }}">
                        <img src="{{ url_for('static', filename='img/bin.png') }}" class="row-icon" />
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="6" class="empty-row">
                      No departments found. Use the form above to add one.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script src="{{ url_for('static', filename='js/admin_departments.js') }}"></script>
</body>
</html>

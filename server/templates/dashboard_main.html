<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Classync ‚Äì Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Poppins font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <link rel="stylesheet"
        href="{{ url_for('static', filename='css/dashboard_main.css') }}">
</head>
<body>

<div class="app-wrapper">
  <!-- ========== SIDEBAR ========== -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <button class="logo-btn" id="sidebarToggle" aria-label="Toggle sidebar">
        <div class="logo-mark">C</div>
        <span class="logo-text classync-brand">Classync</span>
      </button>
    </div>

    <nav class="sidebar-menu">
      <a href="{{ url_for('dashboard') }}" class="menu-item active">
        <span class="menu-icon">üè†</span>
        <span class="menu-label">Dashboard</span>
      </a>
      <a href="{{ url_for('courses') }}" class="menu-item">
        <span class="menu-icon">üìö</span>
        <span class="menu-label">Courses</span>
      </a>
      <a href="{{ url_for('lecturer_analysis') }}" class="menu-item">
        <span class="menu-icon">üìä</span>
        <span class="menu-label">Analysis</span>
      </a>
    </nav>

    <div class="sidebar-bottom">
      <a href="{{ url_for('lecturer_settings') }}" class="menu-item">
        <span class="menu-icon">‚öôÔ∏è</span>
        <span class="menu-label">Settings</span>
      </a>
    </div>
  </aside>

  <!-- ========== MAIN AREA ========== -->
  <div class="main-wrap">
    <!-- Top navbar -->
    <header class="topbar">
      <div class="topbar-center">
        <h1 class="page-title">Dashboard</h1>
      </div>

      <div class="topbar-right">
        <button id="notifToggle" class="icon-btn" aria-label="Notifications">
          üîî
        </button>

        <div class="user-info">
          <div class="avatar">
            {{ current_user.initials if current_user else 'CS' }}
          </div>
          <div class="user-text">
            <div class="user-name">
              {{ current_user.name if current_user else 'Charles Santos' }}
            </div>
            <div class="user-role">
              Lecturer
            </div>
          </div>
        </div>

        <a href="{{ url_for('logout') }}" class="icon-btn" aria-label="Logout">
          ‚èª
        </a>
      </div>
    </header>

    <!-- ========== CONTENT ========== -->
    <main class="dashboard-content">
      <section class="dashboard-grid">

        <!-- HERO ‚Äì spans 2 columns, top row -->
        <section class="card hero-card">
          <div class="hero-text">
            <div class="hero-greeting">Welcome back,</div>
            <h2 class="hero-name">
              {{ current_user.name if current_user else 'Charles Santos' }}
            </h2>
            <p class="hero-subtext">
              Here‚Äôs a quick summary of your classes.
            </p>
          </div>

          <div class="hero-illustration">
                <img 
                    src="{{ url_for('static', filename='img/hero_image.png') }}" 
                    alt="Hero Illustration"
                    class="hero-img"
                >
          </div>
        </section>

        <!-- Engagement Overview ‚Äì full row of 4 KPI cards (same width as hero) -->
        <section class="card engagement-card">
          <div class="engagement-header">
            <div>
              <h2>Engagement Overview</h2>
              <span class="card-subtitle">Snapshot for this week</span>
            </div>
          </div>

          <div class="engagement-kpi-row">
            <!-- Card 1 -->
            <div class="kpi-card kpi-card--good">
              <div class="kpi-label">Avg. engagement</div>
              <div class="kpi-main">{{ overview.avg_engagement }}%</div>
              <div class="kpi-sub">Across all classes</div>
              <div class="kpi-change kpi-change--{{ trend.avg.dir }}">
                <span class="arrow">
                  {% if trend.avg.dir == 'up' %}‚ñ≤
                  {% elif trend.avg.dir == 'down' %}‚ñº
                  {% else %}‚ñ†{% endif %}
                </span>
                <span>{{ trend.avg.text }}</span>
              </div>
            </div>

            <!-- Card 2 -->
            <div class="kpi-card kpi-card--good">
              <div class="kpi-label">Camera on</div>
              <div class="kpi-main">{{ overview.camera_on }}%</div>
              <div class="kpi-sub">Students with camera enabled</div>
              <div class="kpi-change kpi-change--{{ trend.camera.dir }}">
                <span class="arrow">
                  {% if trend.camera.dir == 'up' %}‚ñ≤
                  {% elif trend.camera.dir == 'down' %}‚ñº
                  {% else %}‚ñ†{% endif %}
                </span>
                <span>{{ trend.camera.text }}</span>
              </div>
            </div>

            <!-- Card 3 -->
            <div class="kpi-card kpi-card--bad">
              <div class="kpi-label">Absent rate</div>
              <div class="kpi-main">{{ overview.absent_rate }}%</div>
              <div class="kpi-sub">All registered students</div>
              <div class="kpi-change kpi-change--{{ trend.absent.dir }}">
                <span class="arrow">
                  {% if trend.absent.dir == 'up' %}‚ñ≤
                  {% elif trend.absent.dir == 'down' %}‚ñº
                  {% else %}‚ñ†{% endif %}
                </span>
                <span>{{ trend.absent.text }}</span>
              </div>
            </div>

            <!-- Card 4 -->
            <div class="kpi-card kpi-card--bad">
              <div class="kpi-label">At-risk students</div>
              <div class="kpi-main">{{ overview.at_risk }}</div>
              <div class="kpi-sub">Below 80% attendance</div>
              <div class="kpi-change kpi-change--{{ trend.risk.dir }}">
                <span class="arrow">
                  {% if trend.risk.dir == 'up' %}‚ñ≤
                  {% elif trend.risk.dir == 'down' %}‚ñº
                  {% else %}‚ñ†{% endif %}
                </span>
                <span>{{ trend.risk.text }}</span>
              </div>
            </div>
          </div>
        </section>

        <!-- CALENDAR + UPCOMING ‚Äì full right column, all rows -->
        <section class="card big-right-card calendar-card">
          <!-- Calendar block -->
          <div class="right-card-section upcoming-section">
            <header class="card-header card-header-row">
              <div>
                <h2 id="monthLabel">March</h2>
                <span class="card-subtitle" id="weekdayLabel">Monday</span>
              </div>
              <button class="text-link small" id="todayButton">Today</button>
            </header>

            <!-- JS generates real calendar here -->
            <div class="calendar-grid" id="calendarGrid"></div>

            <p class="calendar-note">
              Click a date to see classes scheduled for that day.
            </p>
          </div>

          <hr class="right-card-divider" />

          <!-- Upcoming class block -->
          <div class="right-card-section">
            <header class="card-header">
              <h2>Upcoming date classes</h2>
              <span class="card-subtitle" id="currentDateText">
                Current date:
              </span>
            </header>

            <div class="upcoming-class" id="upcomingCard">
              <div class="upcoming-tag" id="upcomingTag">Next class</div>

              <div class="upcoming-title" id="upcomingClassTitle">
                CSC4900 ‚Äì Final Year Project
              </div>

              <div class="upcoming-meta" id="upcomingClassMeta">
                10:00 AM ‚Äì 12:00 PM ¬∑ Google Meet
              </div>
              
              <!-- NEW: other classes on the same day -->
              <div class="upcoming-extra-cards" id="upcomingExtraList"></div>

            </div>
          </div>
        </section>

        <!-- Your Recent Class ‚Äì left column, row under hero -->
        <section class="card recent-card">
          <header class="card-header">
            <h2>Your Recent Class</h2>
            <span class="card-subtitle">Showing latest 3 classes</span>
          </header>
          <table class="simple-table">
            <thead>
            <tr>
              <th>No.</th>
              <th>Meet link</th>
              <th>Class</th>
            </tr>
            </thead>
            <tbody>
              {% if classes %}
                {# show only latest 3 classes #}
                {% for c in classes[:3] %}
                  <tr>
                    <td>{{ loop.index }}.</td>
                    <td>
                      {% if c["platform_link"] %}
                        <a href="{{ c["platform_link"] }}" target="_blank">
                          {{ c["platform_link"] }}
                        </a>
                      {% else %}
                        <span>-</span>
                      {% endif %}
                    </td>
                    <td>{{ c["id"] }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                  <tr>
                    <td colspan="3" style="padding: 0.75rem; color: #9CA3AF; font-size: 0.875rem;">
                      No classes found yet.
                    </td>
                  </tr>
              {% endif %}
            </tbody>

          </table>
        </section>

        <!-- Alerts ‚Äì middle column, same row as Recent -->
        <section class="card alerts-card">
          <header class="card-header alerts-header" style="display: flex; justify-content: space-between; align-items: center;">
            
            <h2>Alerts</h2>

            <div style="display: flex; align-items: center; gap: 10px;">
              
              <span class="alerts-count">
                {{ alerts|length }} active
              </span>

              {% if alerts|length > 0 %}
              <button id="alertClearBtn" class="btn-text-danger" style="background: none; border: none; color: #dc3545; font-size: 0.85rem; cursor: pointer; text-decoration: underline;">
                Clear All
              </button>
              {% endif %}
              
            </div>
          </header>

          <ul class="alerts-list" style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
            {% for a in alerts %}
            <li class="alert-row alert-{{ a.level }}" style="padding: 10px 0; border-bottom: 1px solid #eee; display: flex; gap: 10px;">
              <div class="alert-dot" style="width: 8px; height: 8px; border-radius: 50%; background: {% if a.level == 'high' %}#ef4444{% else %}#eab308{% endif %}; margin-top: 5px;"></div>

              <div class="alert-main">
                <div class="alert-top" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 2px;">
                  <span class="alert-class">{{ a.course }}</span>
                  <span class="alert-badge" style="font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #f3f4f6; color: #6b7280; margin-left: 5px;">{{ a.level|capitalize }}</span>
                </div>

                <p class="alert-text" style="margin: 0; font-size: 0.9rem; color: #374151;">
                  {{ a.message }}
                </p>

                {% if a.note %}
                <p class="alert-note" style="margin: 2px 0 0; font-size: 0.8rem; color: #9ca3af;">{{ a.note }}</p>
                {% endif %}
              </div>
            </li>
            {% endfor %}
          </ul>
        </section>

        <!-- Overall Attendance ‚Äì left column, bottom row -->
        <section class="card attendance-card">
          <header class="card-header">
            <h2>Overall Attendance Summary</h2>
          </header>

          <div class="attendance-summary">
            <div class="circle-stat">
              <div class="circle-ring" id="attendanceRing">
                <div class="circle-inner">
                  <div class="circle-value" id="attendanceValue">95%</div>
                  <div class="circle-label" id="attendanceLabel">Present</div>
                </div>
              </div>
            </div>

            <ul class="legend-list" id="attendanceLegend">
              <li class="legend-item active" data-type="present">
                <span class="dot dot-present"></span>Present
              </li>
              <li class="legend-item" data-type="absent">
                <span class="dot dot-absent"></span>Absent
              </li>
              <li class="legend-item" data-type="late">
                <span class="dot dot-late"></span>Late
              </li>
            </ul>
          </div>
        </section>

        <section class="card engagement2-card">
          <header class="card-header">
            <h2>Average Engagement by Course</h2>
            <span class="card-subtitle">Weekly overview</span>
          </header>

          <div class="bar-chart">
            {% if course_engagement %}
              {% for c in course_engagement %}
              <div class="bar-item">
                <span class="bar-label">{{ c.id }}</span>
                <div class="bar-track">
                  <div class="bar-fill" style="width: {{ c.percent }}%;"></div>
                </div>
                <span class="bar-value">{{ c.percent }}%</span>
              </div>
              {% endfor %}
            {% else %}
              <p style="font-size: 0.875rem; color:#9CA3AF; padding:0.5rem 0;">
                No engagement data yet. End at least one session to see results.
              </p>
            {% endif %}
          </div>
        </section>

      </section>
    </main>

    <!-- ========== NOTIFICATION POPUP ========== -->
    <aside id="notifPanel" class="notif-panel" aria-hidden="true">
      <header class="notif-header">
        <h3>Notifications</h3>
        <button id="notifClearBtn" class="text-link small">Clear all</button>
      </header>
      <ul class="notif-list">
        {% if notifications %}
          {% for n in notifications %}
            <li class="notif-item">
              <span class="notif-dot {{ n.level }}"></span>

              <div class="notif-main">
                {% if n.type %}
                  <span class="notif-tag">
                    {{ n.type.replace('_', ' ')|title }}
                  </span>
                {% endif %}
                <span class="notif-message">{{ n.message }}</span>
                <span class="notif-time">
                  {{ n.created_at[11:16] if n.created_at }}
                </span>
              </div>
            </li>

          {% endfor %}
        {% else %}
          <li>No notifications yet.</li>
        {% endif %}
      </ul>
      <footer class="notif-footer">
        <button class="text-link small">View all</button>
      </footer>
    </aside>
  </div>
</div>

<script>
  window.ATTENDANCE_DATA_FROM_SERVER = {{ attendance_data | tojson | safe }}; 
  window.COURSE_SCHEDULE = {{ schedule_by_day | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/dashboard_main.js') }}"></script>
</body>
</html>
